<html>
<head>
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chartist/0.11.4/chartist.min.css"> -->
  <link rel="stylesheet" href="/ui/chartist.min.css">
  <style type="text/css">
	.chart#flowChart {
	    height: 40%;
	    width: 95%;
	}
	.chart#tankChart {
	    height: 20%;
	    width: 95%;
	}
	.chartTitle {
	    margin: 5px;
	}
	.ct-series-a .ct-line {
	    stroke: blue;
	    stroke-width: 2;
	}
	.hdr {
	  display: inline;
	}
	.hdr h4 {
	  display: inline;
	}
	.hdr h1 {
	  display: inline;
	  font-weight: bold;
	  font-size: 40px;
	}
	.hdr span {
	  float: right;
	}
  </style>

  <script type="module"> 
      // import { LineChart, FixedScaleAxis } from 'https://esm.sh/chartist';
      import { LineChart, FixedScaleAxis } from '/ui/chartist.mjs';

      var dataLast;
      const dataStale = 120*1000;
      const spinRate = 200;
      var spinState = 0;

      var flowChart;
      const flowScale = 25.0/32767;

      var tankChart;
      const tankScale = 100.0/32767;

      function reloadPage() {
	  location.reload(true);
      }

      function ticker() {
	  if ( dataLast == null ) {
	      document.getElementById("dataLast").style.color = "yellow";
	      return;
	  }
	  const timeNow = Date.now();

	  if ( timeNow - dataLast.getTime() > dataStale ) {
	      document.getElementById("dataLast").style.color = "red";
	  } else {
	      document.getElementById("dataLast").style.color = "black";
	  }

	  const spinner = "_.:^*  ".split("");   // "-\\|/".split("");
	  spinState++;
	  document.getElementById("spinner").textContent = spinner[spinState % spinner.length];
      }

      function updateCharts() {
	const lookback = document.getElementById("lookback");

	fetch(`http://data.rkroll.com:7777/query/log/-${lookback.value}/-30`)
	    .then(response => response.json())
	    .then(data => {

		const flowData = data.map(d => ({ x: new Date(d[0]*1000), y: d[2] * flowScale }));
	  	const flowLast = flowData[flowData.length - 1];
		const tankData = data.map(d => ({ x: new Date(d[0]*1000), y: d[1] * tankScale }));
	  	const tankLast = tankData[tankData.length - 1];

		dataLast = flowLast.x;

		document.getElementById("dataLast").textContent = dataLast.toLocaleString();
		document.getElementById("flowLast").textContent = flowLast.y.toFixed(0) + " GPM";
		document.getElementById("tankLast").textContent = tankLast.y.toFixed(0) + "%";


		flowChart.update({ series: [flowData] });
		tankChart.update({ series: [tankData] });
	    }
	);
      }

    const chartOptions = {
	  low: 0,
	  showPoint: false,
	  showGrid: false,
	  axisX: { 
	      showGrid: false,
	      type: FixedScaleAxis,
	      divisor: 7,
	      labelInterpolationFnc: value =>
		new Date(value).toLocaleString(undefined, {
		  month: 'short',
		  day: 'numeric',
		  hour: 'numeric',
		  minute: 'numeric'
	      })
    	  },
	  axisY: { 
		showGrid: false,
		onlyInteger: true
	  }
    }
    const flowChartOptions = {
	... chartOptions,
	high: 25,
    }
    const tankChartOptions = {
	... chartOptions,
	high: 100
    }

      function loadPage() {
	  flowChart = new LineChart("#flowChart", { series: [[]] }, flowChartOptions);
	  tankChart = new LineChart("#tankChart", { series: [[]] }, tankChartOptions);

	  updateCharts();
      }

      setInterval(() => { ticker(); }, spinRate);
      setInterval(() => { updateCharts(); }, 20000);
      setInterval(() => { reloadPage(); }, 1000*60*60);

      window.loadPage = loadPage;
      window.updateCharts = updateCharts;
  </script>

</head>
<body onLoad="loadPage()">
    <div class="hdr">
	<h4><b>Twilight Park Water Monitor</b>
	    &nbsp:&nbsp
	    <text id=dataLast>Timer</text>
	    &nbsp:&nbsp
	    <text id=spinner>spinner</text>
	</h4>
	<span>
	Look Back 
	<select name="lookback" id="lookback" onChange="updateCharts();">
	      <option value="1h">Hour</option>
	      <option value="1d" selected>Day</option>
	      <option value="1w">Week</option>
	      <option value="1t">Month</option>
	</select>
	</span>
    </div>
    <br>
    <br>
    <div style="clear:both"></div>

    <div class="hdr"> <center><h1 class="chartTitle">Water Flow<span id=flowLast>Flow</span></h1></center></div>
    <div id="flowChart" class="chart"></div>

    <div class="hdr"> <center><h1 class="chartTitle">Tank Level<span id=tankLast>Tank</span></h1></center></div>
    <div id="tankChart" class="chart"></div>

</body>
</html>
